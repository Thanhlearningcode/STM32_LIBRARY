
# Serial Peripheral Interface (SPI) - STM32F4

### **Introduction**
**Serial Peripheral Interface (SPI)** is a synchronous serial communication protocol used for short-distance communication between microcontrollers and peripheral devices such as sensors, SD cards, or display modules. SPI enables full-duplex data transmission, allowing data to be sent and received simultaneously. The STM32F4 series microcontrollers include built-in SPI peripherals, which can be configured for **master** or **slave** mode operation.

### **How SPI Works**
SPI operates with four main signals:
1. **SCK (Serial Clock)**: Clock signal generated by the master device.
2. **MOSI (Master Out Slave In)**: Data sent from the master to the slave.
3. **MISO (Master In Slave Out)**: Data sent from the slave to the master.
4. **NSS (Slave Select)**: Selects which slave device the master communicates with.

In SPI, data is transmitted in a **full-duplex** manner, meaning the master and the slave can send and receive data simultaneously over the MOSI and MISO lines.

### **SPI Signals**
| Signal | Description                            |
|--------|----------------------------------------|
| **SCK**   | Clock signal generated by the master |
| **MOSI**  | Master to Slave data line           |
| **MISO**  | Slave to Master data line           |
| **NSS**   | Chip Select, selects active slave   |

### **SPI Communication**
SPI uses a **master-slave architecture**, where the master device controls the clock signal and initiates communication. The data is shifted in and out of devices with each clock cycle. The master initiates the clock signal and drives data on the MOSI line, while the slave responds by sending data on the MISO line.

- **Full-duplex communication**: Both data lines (MOSI, MISO) are active, meaning data can be transmitted and received simultaneously.
- **Clock Polarity (CPOL)** and **Clock Phase (CPHA)** are used to determine how data is sampled and transmitted in relation to the clock signal.

### **SPI Configuration on STM32F4**
In STM32F4, SPI can be configured using the following registers:
- **SPI_CR1**: Control register 1, which configures baud rate, data frame format, and clock polarity.
- **SPI_CR2**: Control register 2, which manages the communication mode and interrupt enable.
- **SPI_SR**: Status register, which provides information about the state of SPI communication.
- **SPI_DR**: Data register, used for sending and receiving data.

### **Basic SPI Setup**
#### **GPIO Configuration**
- **PA4 (NSS)**: Output, manually controlled for selecting the slave.
- **PA5 (SCK)**: Configured for Alternate Function (AF5).
- **PA6 (MISO)**: Configured for Alternate Function (AF5).
- **PA7 (MOSI)**: Configured for Alternate Function (AF5).

#### **Example Code for Initialization**
```c
void SPI_Init(void){
    // Enable Clock for GPIOA and SPI1
    RCC->AHB1ENR |= (1 << 0);  // Enable GPIOA clock
    RCC->APB2ENR |= (1 << 12); // Enable SPI1 clock

    // Configure GPIO for SPI
    GPIOA->MODER &= ~(0xFF << 8);  // Clear bits
    GPIOA->MODER |= (1U << 8);     // Set PA4 as output for NSS
    GPIOA->MODER |= (2U << 10);    // Set PA5 as AF for SCK
    GPIOA->MODER |= (2U << 12);    // Set PA6 as AF for MISO
    GPIOA->MODER |= (2U << 14);    // Set PA7 as AF for MOSI

    // Configure SPI1
    SPI1->CR1 |= (1 << 3);  // Set baud rate (Fpclk / 4)
    SPI1->CR1 &= ~(1 << 7); // MSB first
    SPI1->CR1 |= (1 << 8);  // Internal slave select
    SPI1->CR1 |= (1 << 9);  // Software slave management
    SPI1->CR1 |= (1 << 10); // Full duplex mode
    SPI1->CR1 &= ~(1 << 11); // 8-bit data frame
    SPI1->CR1 |= (3U << 0); // Set CPOL and CPHA (Clock Polarity and Phase)
    SPI1->CR1 |= (1 << 2);  // Master mode
    SPI1->CR1 |= (1 << 6);  // Enable SPI
}

void SPI_Transmit(uint8_t *data, int size){
    for (int i = 0; i < size; i++) {
        while (!(SPI1->SR & (1 << 1)));  // Wait until TXE (Transmit buffer empty) is set
        SPI1->DR = data[i];              // Send data
    }
}




### **FINALLY*
Modes of Operation
Mode 0: CPOL = 0, CPHA = 0
Mode 1: CPOL = 0, CPHA = 1
Mode 2: CPOL = 1, CPHA = 0
Mode 3: CPOL = 1, CPHA = 1
Advantages of SPI
Fast Data Transfer: SPI can achieve higher data rates than I2C due to its simple, full-duplex operation.
Simplicity: Easier to implement compared to protocols like I2C.
Multiple Slaves: Can communicate with multiple slave devices using a single master.
Disadvantages of SPI
More Pins Required: Needs separate lines for each device (MOSI, MISO, NSS, and SCK).
No Acknowledgment: SPI lacks an acknowledgment mechanism like I2C.
Use Cases
Sensor Communication: Interfacing with temperature sensors, gyroscopes, etc.
Data Storage: Communicating with SD cards and flash memory.
Display Modules: Transmitting data to LCD or OLED displays.
Conclusion
SPI is a simple and efficient communication protocol widely used in embedded systems. By learning to configure SPI registers manually, developers gain a deeper understanding of how data flows between the microcontroller and peripherals, enabling more control and flexibility in their designs.

References
STM32F4 Reference Manual
Serial Peripheral Interface (Wikipedia)
